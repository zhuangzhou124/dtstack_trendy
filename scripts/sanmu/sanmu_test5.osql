--***********************************
-- 表   dwd_order_region_1d
-- 功能描述：采购数据明细表
-- 生命周期：30天
-- 调度周期：天
-- 创建者：  三木
-- 创建日期：20191125
-- 修改日志：
--***********************************
-- drop table dwd_order_region_1d;

CREATE TABLE IF NOT EXISTS dwd_order_region_1d(
	region_id                                        STRING COMMENT '大区id     ',
	region_name                                      STRING COMMENT '大区名称     ',
	order_level1_id                                  STRING COMMENT '编号（1级）    ',
	order_level2_id                                  STRING COMMENT '编号（2级）',
	order_requirement_weight                         STRING COMMENT '需求重量(KG)   ',
	order_actual_take_weight                         DOUBLE COMMENT '提货重量（KG',
	order_stock_in_weight                            DOUBLE COMMENT '入库重量（KG）',
	order_interval_days_1d_sign_approval             BIGINT COMMENT '订单签订和审批周期',
	order_interval_days_1d_market_delivery           BIGINT COMMENT '订单市场交货周期',
	order_interval_days_1d_delivery                  BIGINT COMMENT '订单交货周期（按采购合同约定时间)',
	order_interval_days_1d_send_stock_in             BIGINT COMMENT '发货- 入库周期',
	order_interval_days_1d_stock_in_payment          BIGINT COMMENT '入库 -挂账周期',
	order_interval_days_1d_payment_account           BIGINT COMMENT '挂账-付款周期',
	price_analysis_supplier                          DOUBLE COMMENT '供应商价格分析',
	order_interval_days_1d_overstock                 BIGINT COMMENT '订单积压周期'
)COMMENT '采购数据明细表' PARTITIONED BY(
	ds STRING COMMENT '时间分区')
LIFECYCLE 30;

INSERT OVERWRITE TABLE dwd_order_region_1d PARTITION(ds = '${bdp.system.bizdate}')
	SELECT region_id,
				 order_level1_id,
				 order_level2_id,
				 order_requirement_weight,
				 order_actual_take_weight,
				 order_stock_in_weight,
				 datediff(order_create_date, order_requirement_send_date) AS order_interval_days_1d_sign_approval,
				 datediff(order_market_requirement_delivery_date, order_finish_date) AS order_interval_days_1d_market_delivery,
				 datediff(order_finish_date, order_requirement_delivery_date) AS order_interval_days_1d_delivery,
				 datediff(order_stock_in_date, order_actual_take_date) AS order_interval_days_1d_send_stock_in,
				 datediff(order_payment_date, order_stock_in_date) AS order_interval_days_1d_stock_in_payment,
				 datediff(order_account_date, order_payment_date) AS order_interval_days_1d_payment_account,
				 CASE
				 WHEN order_requirement_weight <> 0 AND order_requirement_weight IS NOT NULL THEN substr((order_stock_in_weight /
				 order_requirement_weight) * 100,1,2)
				 ELSE null
				 END AS price_analysis_supplier,
				 datediff(order_actual_take_date, order_finish_date) AS order_interval_days_1d_overstock
	FROM ods_yichang_purchase WHERE ds = '${bdp.system.bizdate}'
	group by region_id;


SELECT region_id,
			 sum(CASE
			 WHEN substr((order_stock_in_weight /
			 order_requirement_weight) * 100,1,2) >= 20 THEN 1
			 ELSE 0
			 END) AS order_nums_1d_price_up_20per
FROM ods_yichang_purchase WHERE ds = '${bdp.system.bizdate}'
group by region_id