--name:ads_api_crm_ma_clerk_grade_15mm_1
--author:xuzhengzhi
--create time:2019-10-14 19:01
--desc:当天增量 15min更新一次


INSERT OVERWRITE TABLE ads_api_crm_ma_clerk_grade_15mm_1 PARTITION(ds = '${cycdate}')
	SELECT coalesce(tmp1.org_code, '-110')
	,
				 coalesce(tmp1.store_no, '-110')
	,
				 coalesce(tmp1.clerk_no, '-110')
	,
				 coalesce(tmp1.grade_id, '-110')
	,
				 'today' AS date_type
	,
				 '${cycdate}' AS date_id
	,
				 tmp1.member_cnt
	,
				 '${cycdate}' AS biz_date
	FROM (
		SELECT org_code
		,
					 store_no
		,
					 clerk_no
		,
					 after_grade_id
		,
					 COUNT(DISTINCT member_no) AS member_cnt
		FROM ${td_ods}.ods_member_grade_log
	WHERE ds = ${cycdate}
	AND REPLACE(grade_change_time, '-', '') = ${cycdate}
	AND after_grade_id > before_grade_id
	GROUP BY org_code
	, store_no
	, clerk_no
	, after_grade_id
)tmp1;



