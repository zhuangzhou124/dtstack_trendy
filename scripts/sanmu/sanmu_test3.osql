--name:ads_api_tpos_tdrp_wfx_channel_endpoint_1d
--author:sanmu
--create time:2019-10-09 11:29
--drop table ads_api_tpos_tdrp_wfx_channel_endpoint_1d
--***********************************
-- 表   名：ads_api_tpos_tdrp_wfx_channel_endpoint_1d
-- 功能描述：日期+门店粒度汇总表
-- 生命周期：30天
-- 调度周期：周期调度
-- 创建者：  三木
-- 创建日期：20191008
-- 修改日志：
--***********************************



CREATE TABLE IF NOT EXISTS ads_api_tpos_tdrp_wfx_channel_endpoint_1d(
	biz_date                                              STRING COMMENT '统计日期',
	channel_endpoint                                      STRING COMMENT '门店编码',
	new_card_num_1d_store_vip                             BIGINT COMMENT 'VIP新开卡数',
	total_card_num_td_store_vip                           BIGINT COMMENT 'VIP累计开卡数',
	date_type                                             STRING COMMENT '日期类型',
	date_id                                               STRING COMMENT '日期'
)COMMENT '日期+门店粒度汇总表' PARTITIONED BY(
	ds STRING COMMENT '时间分区');


INSERT OVERWRITE TABLE ads_api_tpos_tdrp_wfx_channel_endpoint_1d PARTITION(ds = '${today}')
	SELECT '${today}' AS biz_date,
				 t5.member_manage_channel_endpoint_code,
				 t5.new_card_num_1d_store_vip,
				 t5.total_card_num_td_store_vip,
				 'today' AS date_type,
				 '${today}' AS date_id
	FROM (
		SELECT t4.member_manage_channel_endpoint_code,
					 COUNT(DISTINCT CASE
					 WHEN t4.member_register_time = '${today}' THEN t4.member_no
					 END) AS new_card_num_1d_store_vip,
					 COUNT(DISTINCT t4.member_no) AS total_card_num_td_store_vip
		FROM (
			SELECT t1.member_manage_channel_endpoint_code,
						 t3.is_vip,
						 t1.org_code,
						 t1.member_register_time,
						 t1.member_no
			FROM (
				SELECT member_manage_channel_endpoint_code,
							 member_no,
							 substr(regexp_replace(member_register_time, '-', '', 0),1,8)
							 AS member_register_time,
							 org_code
				FROM ${td_ods}.ods_member_card
				WHERE ds = '${today}' AND STATUS > -1
				AND member_manage_channel_endpoint_code IS NOT NULL) t1
				LEFT JOIN (
					SELECT org_code,
								 member_no,
								 grade_id
					FROM ${td_ods}.ods_member_grade_state
					WHERE ds = '${today}') t2
					ON t1.org_code = t2.org_code AND t1.member_no = t2.member_no
				LEFT JOIN (
					SELECT grade_id,
								 is_vip
					FROM ${td_ods}.ods_member_grade_info
					WHERE ds = '${today}' AND is_vip = '1') t3
					ON t2.grade_id = t3.grade_id) AS t4
		WHERE t4.is_vip = '1'
		GROUP BY t4.member_manage_channel_endpoint_code) AS t5;




