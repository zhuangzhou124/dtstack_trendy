select  t1.org_code
, t1.channel_endpoint_code
, t1.sku_code
, sum( qty ) as qty
from   (
	select  sl.org_code
	, sl.channel_endpoint_code
	, sli.sku_code
	, sli.qty_actual as qty
	from   ${td_ods}.ods_stock_logic_items sli
		left join ${td_ods}.ods_stock_logic sl
			on    sli.stock_logic_id = sl.id
	where  1 = 1
	and   sli.ds = '20191106'
and   sl.ds = '20191106'

union all

--出库单，加回去
select  sl.org_code
, sl.channel_endpoint_code
, ii.sku_code
, ii.qty_sended as qty
from   ${td_ods}.ods_stock_logic_order_out as o
	inner join ${td_ods}.ods_stock_logic_order_out_items as ii
		on    o.id = ii.logic_order_out_id
	left join ${td_ods}.ods_stock_logic sl
		on    o.stock_logic_id = sl.id
where  1 = 1
and   o.ds = '20191106'
and   ii.ds = '20191106'
and   sl.ds = '20191106'
and   date(o.made_order_time) <= '2019-11-06'

union all

--入库单，库存反减回去
select  sl.org_code
, sl.channel_endpoint_code
, ii.sku_code
, -1 * ii.qty_received as qty
from   ${td_ods}.ods_stock_logic_order_in as i
	inner join ${td_ods}.ods_stock_logic_order_in_items as ii
		on    i.id = ii.logic_order_in_id
	left join ${td_ods}.ods_stock_logic sl
		on    i.stock_logic_id = sl.id
where  1 = 1
and   i.ds = '20191106'
and   ii.ds = '20191106'
and   sl.ds = '20191106'
and   date(i.made_order_time) <= '2019-11-06'
) as t1
where  1 = 1
and   t1.channel_endpoint_code = '1201'
group by
t1.org_code
, t1.channel_endpoint_code
, t1.sku_code
;