SELECT t1.org_code,
			 t1.channel_endpoint_code,
			 t1.sku_code,
			 sum(qty) AS qty
FROM (
	SELECT sl.org_code,
				 sl.channel_endpoint_code,
				 sli.sku_code,
				 sli.qty_transit AS qty
	FROM ${td_ods}.ods_stock_logic_items sli
	LEFT JOIN ${td_ods}.ods_stock_logic sl
		ON sli.stock_logic_id = sl.id AND sl.ds = '${bizdate}'
WHERE sli.ds = '${bizdate}'
UNION ALL
--根据收货通知单计算：+加上实收数，-去计划数
SELECT sl.org_code,
			 sl.channel_endpoint_code,
			 ii.sku_code,
			 -1 * ii.qty_receivable AS qty
FROM ${td_ods}.ods_stock_logic_order_in_notify AS i
INNER JOIN ${td_ods}.ods_stock_logic_order_in_notify_items AS ii
	ON i.id = ii.logic_order_in_notify_id AND ii.ds = '${bizdate}'
INNER JOIN ${td_ods}.ods_stock_logic sl
	ON i.stock_logic_id = sl.id AND sl.ds = '${bizdate}'
JOIN (
						SELECT date_id,
									 date_type,
									 time_id
						FROM td_ads_dev.dim_time
						WHERE ds = '${bizdate}' AND date_type = 'year'
						GROUP BY date_id,
						date_type,
						time_id) AS time
	ON substr(regexp_replace(i.made_order_time, '-', '', 0), 1, 8) = time.time_id
WHERE i.ds = '${bizdate}' AND i.business_order_type = '201'

UNION ALL
---------------------新加的逻辑
SELECT sl.org_code,
			 sl.channel_endpoint_code,
			 ii.sku_code,
			 ii.qty_received AS qty
FROM ${td_ods}.ods_stock_logic_order_in AS i
INNER JOIN ${td_ods}.ods_stock_logic_order_in_items AS ii
	ON i.id = ii.logic_order_in_id AND ii.ds = '${bizdate}'
INNER JOIN ${td_ods}.ods_stock_logic sl
	ON i.stock_logic_id = sl.id AND sl.ds = '${bizdate}'
JOIN (
						SELECT date_id,
									 date_type,
									 time_id
						FROM td_ads_dev.dim_time
						WHERE ds = '${bizdate}' AND date_type = 'year'
						GROUP BY date_id,
						date_type,
						time_id) AS time
	ON substr(regexp_replace(i.made_order_time, '-', '', 0), 1, 8) = time.time_id
WHERE i.business_order_type = '201' AND i.ds = '${bizdate}'

UNION ALL
--收发差异单，+差异数

SELECT s.org_code,
			 s.channel_endpoint_code,
			 b.sku_code,
			 b.qty_difference AS qty
FROM ${td_ods}.ods_stock_logic_order_difference AS a
INNER JOIN ${td_ods}.ods_stock_logic_order_difference_items AS b
	ON a.id = b.logic_order_difference_id AND b.ds = '${bizdate}'
INNER JOIN ${td_ods}.ods_stock_logic s
	ON a.stock_logic_in_id = s.id AND s.ds = '${bizdate}'
JOIN (
						SELECT date_id,
									 date_type,
									 time_id
						FROM td_ads_dev.dim_time
						WHERE ds = '${bizdate}' AND date_type = 'year'
						GROUP BY date_id,
						date_type,
						time_id) AS time
	ON substr(regexp_replace(a.made_order_time, '-', '', 0), 1, 8) = time.time_id
WHERE a.ds = '${bizdate}'
