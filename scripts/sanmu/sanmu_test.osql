--name:sanmu_test
--author:sanmu
--create time:2019-09-26 14:45
--drop table sanmu_test

SELECT trigger_order_no,
			 before_grade_id,
			 after_grade_id,
			 grade_change_time,
			 change_reason,
			 create_user
FROM ods_member_grade_log
WHERE ds = '${bizdate}' and trigger_order_no is not null;

select * from ads_api_tpos_tdrp_wfx_order_channel_endpoint_brand_1d where ds = '20190920' ;

SELECT org_code,
			 sales_order_no,
			 order_type,
			 member_no,
			 member_grade_code,
			 qty_sales_item,
			 channel_endpoint_code,
			 amt_total,
			 substr(regexp_replace(create_time, '-', '', 0), 1, 8) AS order_time
FROM ods_sales_order
WHERE ds = '${bizdate}' and member_grade_code in ('44','14','5','9');



--期初在库数
SELECT t1.org_code,
			 t1.owner_channel_code,
			 t1.sku_code,
			 sum(qty) AS qty
FROM (
	SELECT sl.org_code,
				 sli.owner_channel_code,
				 sli.sku_code,
				 sli.qty_actual AS qty
	FROM ods_stock_logic_items sli
		LEFT JOIN ods_stock_logic sl
			ON sli.stock_logic_id = sl.id
	UNION ALL
	--出库单，加回去
	SELECT sl.org_code,
				 ii.owner_channel_code,
				 ii.sku_code,
				 ii.qty_sended AS qty
	FROM ods_stock_logic_order_out AS o
		INNER JOIN ods_stock_logic_order_out_items AS ii
			ON o.id = ii.logic_order_out_id
		LEFT JOIN ods_stock_logic sl
			ON o.stock_logic_id = sl.id
	WHERE o.made_order_time >= '2019-09-01 00:00:00'
	UNION ALL
	--入库单，库存反减回去
	SELECT sl.org_code,
				 ii.owner_channel_code,
				 ii.sku_code,
				 - 1 * ii.qty_received AS qty
	FROM ods_stock_logic_order_in AS i
		INNER JOIN ods_stock_logic_order_in_items AS ii
			ON i.id = ii.logic_order_in_id
		LEFT JOIN ods_stock_logic sl
			ON i.stock_logic_id = sl.id
	WHERE i.made_order_time >= '2019-09-01 00:00:00'

) AS t1
GROUP BY t1.org_code,
t1.owner_channel_code,
t1.sku_code;



--期初在途数
SELECT t1.org_code,
			 t1.owner_channel_code,
			 t1.sku_code,
			 sum(qty) AS qty
FROM (
	SELECT sl.org_code,
				 sli.owner_channel_code,
				 sli.sku_code,
				 sli.qty_transit AS qty
	FROM ods_stock_logic_items sli
		LEFT JOIN ods_stock_logic sl
			ON sli.stock_logic_id = sl.id
	UNION ALL
	--根据收货通知单计算：+加上实收数，-去计划数
	SELECT sl.org_code,
				 ii.owner_channel_code,
				 ii.sku_code,
				 ii.qty_received - ii.qty_receive_plan AS qty
	FROM ods_stock_logic_order_in_notify AS i
		INNER JOIN ods_stock_logic_order_in_notify_items AS ii
			ON i.id = ii.logic_order_in_notify_id
		INNER JOIN ods_stock_logic sl
			ON i.stock_logic_id = sl.id
	WHERE i.made_order_time >= '2019-09-01 00:00:00'
	UNION ALL
	--收发差异单，+差异数

	SELECT s.org_code,
				 b.owner_channel_code,
				 b.sku_code,
				 b.qty_difference AS qty
	FROM ods_stock_logic_order_difference AS a
		INNER JOIN ods_stock_logic_order_difference_items AS b
			ON a.id = b.logic_order_difference_id
		INNER JOIN ods_stock_logic s
			ON a.stock_logic_in_id = s.id
	WHERE a.made_order_time >= '2019-09-01 00:00:00'

) AS t1
GROUP BY t1.org_code,
			 t1.owner_channel_code,
			 t1.sku_code;



--调拨入数量
SELECT i.org_code,
			 b.owner_channel_code,
			 b.sku_code,
			 b.qty_received AS qty
FROM ods_stock_logic_order_in AS a
	INNER JOIN ods_stock_logic_order_in_items AS b
		ON a.id = b.logic_order_in_id
	INNER JOIN ods_stock_logic AS i
		ON a.stock_logic_id = i.id
WHERE 1 = 1 AND business_order_type = '301' AND business_order_business_type IN ('30101', '30102') AND app_id = 'TPOS'
AND a.made_order_time >= '2019-08-01 00:00:00';




--ptcsl

SELECT o.org_code,
			 b.owner_channel_code,
			 b.sku_code,
			 b.qty_received AS qty
FROM ods_stock_logic_order_out AS a
	INNER JOIN ods_stock_logic_order_out_items AS b
		ON a.id = b.logic_order_out_id
	INNER JOIN ods_stock_logic AS o
		ON a.stock_logic_id = i.id
WHERE 1 = 1 AND business_order_type = '302' AND business_order_business_type IN ('30201', '30202') AND app_id = 'TPOS'
AND a.made_order_time >= '2019-09-01 00:00:00';







--pdcysl
SELECT o.org_code,
			 b.owner_channel_code,
			 b.sku_code,
			 b.qty_sended AS qty
FROM ods_stock_logic_order_out AS a
	INNER JOIN ods_stock_logic_order_out_items AS b
		ON a.id = b.logic_order_out_id
	INNER JOIN ods_stock_logic AS o
		ON a.stock_logic_id = o.id

WHERE 1 = 1 AND business_order_type = '201' AND business_order_business_type = '20101' AND a.app_id = 'TDRP'
AND a.made_order_time >= '2019-09-01 00:00:00';



--qmzks
SELECT o.org_code,
			 b.owner_channel_code,
			 b.sku_code,
			 b.qty_received AS qty
FROM ods_stock_logic_order_in AS a
	INNER JOIN ods_stock_logic_order_in_items AS b
		ON a.id = b.logic_order_in_id
	INNER JOIN ods_stock_logic AS o
		ON a.stock_logic_id = o.id

WHERE 1 = 1 AND business_order_type = '201' AND business_order_business_type = '20104' AND a.app_id = 'TDRP'
AND a.made_order_time >= '2019-09-01 00:00:00';


--qmzts
SELECT sl.org_code,
			 sl.channel_endpint_code,
			 sli.sku_code,
			 sum(sli.qty_transit)
FROM ods_stock_logic_items sli
	LEFT JOIN ods_stock_logic sl
		ON sli.stock_log_id = sl.id
GROUP BY sl.org_code, sl.channel_endpint_code, sli.sku_code;

SELECT sl.org_code,
			 sl.channel_endpint_code,
			 sli.sku_code,
			 sum(sli.qty_transit)
FROM ods_stock_logic_items sli
	LEFT JOIN ods_stock_logic sl
		ON sli.stock_log_id = sl.id
GROUP BY sl.org_code, sl.channel_endpint_code, sli.sku_code







--会员总数
SELECT member_manage_clerk,
			 COUNT(DISTINCT member_no) AS member_qty_all
FROM ods_member_card
WHERE STATUS > 0 AND CAST(member_no AS bigint) > 1
GROUP BY member_manage_clerk;


--活跃会员人数
select t2.member_manage_clerk,COUNT(DISTINCT t1.member_no) from
(SELECT
			 member_no
FROM ods_sales_order
WHERE CAST(member_no AS bigint) > 1 and ds = '${bizdate}' and price_amt_discount > 0
GROUP BY member_no
HAVING datediff(to_date('${bizdate}','yyyymmdd'), to_date(max(create_time),'yyyy-mm-dd hh:mi:ss'),'dd')
BETWEEN 0 AND 90) as t1
left outer join
(SELECT member_manage_clerk,
				member_no
 FROM ods_member_card
 WHERE STATUS > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}') as t2
on t1.member_no = t2.member_no
group by t2.member_manage_clerk;


--沉默会员人数
select t2.member_manage_clerk,COUNT(DISTINCT t1.member_no) from
(SELECT
			 member_no
FROM ods_sales_order
WHERE price_amt_discount > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}'
GROUP BY member_no
HAVING datediff(to_date('${bizdate}','yyyymmdd'), to_date(max(create_time),'yyyy-mm-dd hh:mi:ss'),'dd')
BETWEEN 90 AND 180)as t1
	left outer join
	(SELECT member_manage_clerk,
					member_no
	 FROM ods_member_card
	 WHERE STATUS > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}') as t2
		on t1.member_no = t2.member_no
group by t2.member_manage_clerk;


--沉睡会员人数
select t2.member_manage_clerk,COUNT(DISTINCT t1.member_no) from
(SELECT
			 member_no
FROM ods_sales_order
WHERE price_amt_discount > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}'
GROUP BY member_no
HAVING datediff(to_date('${bizdate}','yyyymmdd'), to_date(max(create_time),'yyyy-mm-dd hh:mi:ss'),'dd')
BETWEEN 180 AND 270) as t1
	left outer join
	(SELECT member_manage_clerk,
					member_no
	 FROM ods_member_card
	 WHERE STATUS > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}') as t2
		on t1.member_no = t2.member_no
group by t2.member_manage_clerk;


--预流失会员人数
select t2.member_manage_clerk,COUNT(DISTINCT t1.member_no) from
(SELECT
			 member_no
FROM ods_sales_order
WHERE price_amt_discount > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}'
GROUP BY member_no
HAVING datediff(to_date('20190927','yyyymmdd'), to_date(max(create_time),'yyyy-mm-dd hh:mi:ss'),'dd')
BETWEEN 270 AND 365) as t1
	left outer join
	(SELECT member_manage_clerk,
					member_no
	 FROM ods_member_card
	 WHERE STATUS > 0 AND CAST(member_no AS bigint) > 1 and ds = '${bizdate}') as t2
		on t1.member_no = t2.member_no
group by t2.member_manage_clerk;



--新增会员
SELECT t2.org_code
,
			 COUNT(DISTINCT t2.member_no) AS new_member_qty
FROM (
	SELECT member_no
	FROM ods_member_info
	WHERE ds = '${bizdate}' AND STATUS > 0) t1
	JOIN (
		SELECT member_no,
					 org_code,
					 member_register_time
		FROM ods_member_card
		WHERE ds = '${bizdate}') t2
		ON t2.member_no = t1.member_no
	LEFT JOIN (
		SELECT org_code
		,
					 member_no
		,
					 min(create_time) AS first_order_time
		FROM ods_sales_order
		WHERE substr(regexp_replace(audit_time, '-', '', 0), 1, 8) <= '${bizdate}' AND ds = '${bizdate}'
		AND price_amt_discount > 0 AND member_no NOT IN ('-1', '1')
		GROUP BY org_code, member_no
	) t3
		ON t3.org_code = t2.org_code AND t3.member_no = t2.member_no
WHERE substr(regexp_replace(t2.member_register_time, '-', '', 0), 1, 8) <= '${bizdate}'
AND t2.member_no NOT IN ('-1', '1') AND substr(regexp_replace(t3.first_order_time, '-', '', 0), 1, 8) = '${bizdate}'
GROUP BY t2.org_code;
-----------------








--吊牌金额
	SELECT channel_endpoint_code,
				 sum(price_amt_retail)
	FROM ods_sales_order
	WHERE ds = '${bizdate}'
	group by channel_endpoint_code;


--客流统计store_passenger_flow
	SELECT store_code,
				 in_count
	FROM ods_store_passenger_flow
	WHERE ds = '${bizdate}'
	group by store_code;


--退货件数、退货金额
	SELECT
				 channel_endpoint_code,
				 sum(qty_return_item) AS return_item_quantity,
				 sum(amt_return_item) as return_item_amount
	FROM ods_sales_order
	WHERE order_type IN (103) and ds = '${bizdate}'
	group by channel_endpoint_code;

--净销售量
	SELECT so.channel_endpoint_code,
				 sum(soi.qty_product) as net_sales_item_quantity
	FROM (
		SELECT sales_order_no,
					 qty_product
		FROM ods_sales_order_item
		WHERE ds = '${bizdate}' AND price_discount > 0 AND qty_product > 0) soi
		LEFT JOIN (
			SELECT channel_endpoint_code,
						 sales_order_no
			FROM ods_sales_order
			WHERE ds = '${bizdate}' and price_amt_discount > 0) so
			ON soi.sales_order_no = so.sales_order_no
	group by so.channel_endpoint_code;


--净销售额（含现金券）

	SELECT
	channel_endpoint_code,
	sum(amt_total) as net_sales_item_amount
	FROM ods_sales_order where ds = '${bizdate}'
	and price_amt_discount > 0
	group by channel_endpoint_code;

--成交笔数（不减去退货笔数）
	SELECT
	channel_endpoint_code,
	count(1) as deal_quantity
	FROM ods_sales_order
	WHERE ds = '${bizdate}' and (order_type IN ('101', '103')
	OR (order_type = '104' AND (amt_total != 0 OR (amt_total = 0 AND qty_order_item > 0))))
	group by channel_endpoint_code;



--退换笔数
	SELECT
	channel_endpoint_code,
	count(1) as rma_quantity
	FROM ods_sales_order
	WHERE order_type IN ('103', '104') and ds = '${bizdate}'
	group by channel_endpoint_code;



--平均折扣
	SELECT
	channel_endpoint_code,
	sum(amt_total) as sales_item_amount
	FROM ods_sales_order where ds = '${bizdate}'
	group by channel_endpoint_code;



--vip销售件数、
	SELECT so.channel_endpoint_code,
				 sum(soi.qty_product) as item_quantity_of_vip_sales_order
	FROM (
		SELECT sales_order_no,qty_product
		FROM ods_sales_order_item
		WHERE ds = '${bizdate}' AND price_discount > 0 AND qty_product > 0) soi
		LEFT JOIN (
			SELECT channel_endpoint_code,
						 member_grade_code,
						 sales_order_no,
						 amt_total
			FROM ods_sales_order
			WHERE ds = '${bizdate}') so
			ON soi.sales_order_no = so.sales_order_no
		LEFT JOIN (
			SELECT grade_code
			FROM ods_member_grade_info
			WHERE ds = '${bizdate}' AND is_vip = '1') mgi
			ON so.member_grade_code = mgi.grade_code
	group by so.channel_endpoint_code;


--vip销售金额
SELECT t1.channel_endpoint_code,
			 sum(t1.amt_total) as item_amount_of_vip_sales_order
FROM (
	SELECT so.channel_endpoint_code,
				 so.amt_total,
				 mgi.is_vip
	FROM (
			SELECT channel_endpoint_code,
						 member_grade_code,
						 sales_order_no,
						 amt_total
			FROM ods_sales_order
			WHERE ds = '${bizdate}') so
		LEFT JOIN (
			SELECT grade_code,is_vip
			FROM ods_member_grade_info
			WHERE ds = '${bizdate}' AND is_vip = '1') mgi
			ON so.member_grade_code = mgi.grade_code) AS t1
where t1.is_vip = 1 group by t1.channel_endpoint_code;


--现金劵

	SELECT so.channel_endpoint_code,
				 sum(sop.amt_pay) as cash_coupon
	FROM (
		SELECT sales_order_no,
					 amt_pay
		FROM ods_sales_order_payment
		WHERE ds = '${bizdate}' AND pay_way = 'COUPON') sop
		LEFT JOIN (
			SELECT sales_order_no,
						 channel_endpoint_code
			FROM ods_sales_order
			WHERE ds = '${bizdate}') so
			ON sop.sales_order_no = so.sales_order_no
	group by so.channel_endpoint_code;









